"use strict";function empty(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function init(){ws=new WebSocket("ws:/"+window.location.hostname+"/ws"),ws.onmessage=processMessage,ws.onclose=reconnect,ws.onopen=function(){ws.send("[7]"),ws.send("[8]"),ws.send("[9]"),ws.send("[10]"),setTimeout(link,2e3)}}function reconnect(){console.error("WebSocket getrennt. Erneut verbinden in 2 s..."),clearTimeout(ws.timeout),ws.timeout=setTimeout(init,2e3)}function processMessage(e){try{let t=JSON.parse(e.data),n=[void 0,gotStatus,gotLog,void 0,settingResponse,parameterResponse,gotPv,gotCommandList,gotSettingList,gotParameterList,gotPvList];n[t[0]](t[1])}catch(e){console.error(e)}displayConnectivity()}function displayConnectivity(){if("undefined"==displayConnectivity.locked&&(displayConnectivity.locked=!1),displayConnectivity.locked)return;displayConnectivity.locked=!0,setTimeout(function(){displayConnectivity.locked=!1},100);let e=$("#ws")[0],t={"-":"\\","\\":"|","|":"/","/":"-"};e.innerHTML=t[e.innerHTML]}function gotStatus(e){ws.send("[1,1]")}function gotLog(e){let t=$("[name=logFilter]")[0].value;if(!e.includes(t))return;let n=$("#log")[0],i=e.charAt(0),o=document.createElement("pre");o.innerHTML=e;let l={E:"red",W:"orange",I:"green",D:"black",V:"gray"};o.style.color=l[i],n.prepend(o)}function genericCreateForm(e,t,n,i,o){empty(t);for(let l of e){let e=document.createElement("fieldset");e.name=l[0],e.innerHTML="<legend>"+l[0]+"</legend>";for(let t of l[1])e.innerHTML+="<input type='"+n+"' name='"+t+"' value='"+(i||t)+"'> ",o&&(e.innerHTML+="<label for='"+t+"'>"+t+"</label><br>");t.appendChild(e)}}function gotCommandList(e){let t=$("#commands")[0];genericCreateForm(e,t,"button",void 0,!1),t.addEventListener("click",commandClick,!0)}function commandClick(e){let t=e.target,n=t.parentNode,i=$("fieldset",t.form).indexOf(n),o=$("input",n).indexOf(t);ws.send("[3,["+i+","+o+"]]")}function gotSettingList(e){let t=$("#settings")[0];genericCreateForm(e,t,"number","0",!0),$("input",t).forEach(valueRequest),t.addEventListener("blur",valueBlur,!0)}function settingResponse(e){let t=$("#settings")[0],n=$("fieldset",t)[e[0]],i=$("input",n)[e[1]];i.setAttribute("qType",e[2]),i.value=e[3],i.dispatchEvent(new Event("change"))}function gotParameterList(e){let t=$("#parameters")[0];genericCreateForm(e,t,"number","0",!0),$("input",t).forEach(valueRequest),t.addEventListener("blur",valueBlur,!0)}function parameterResponse(e){let t=$("#parameters")[0],n=$("fieldset",t)[e[0]],i=$("input",n)[e[1]];i.setAttribute("qType",e[2]),i.value=e[3],i.dispatchEvent(new Event("change"))}function valueRequest(e){let t=e.parentNode,n=$("fieldset",e.form).indexOf(t),i=$("input",t).indexOf(e);ws.send("["+("settings"==e.form.id?4:5)+",["+n+","+i+"]]")}function valueBlur(e){let t=e.target,n=t.parentNode,i=$("fieldset",t.form).indexOf(n),o=$("input",n).indexOf(t),l=t.value;if(t.attributes.qType){switch(parseInt(t.attributes.qtype.value)){case 1:l<0&&(l=0);case 2:l=Math.round(l);case 3:break;default:return}ws.send("["+("settings"==t.form.id?4:5)+",["+i+","+o+","+t.value+"]]")}}function gotPvList(e){let t=$("#pvs")[0];genericCreateForm(e,t,"button","Registrieren",!0);for(let e of $("input",t))e.addEventListener("click",pvRegister)}function pvRegister(e){let t=e.target,n=t.parentNode,i=$("fieldset",t.form).indexOf(n),o=$("input",n).indexOf(t);t.value=0,t.type="number",ws.send("[6,["+i+","+o+"]]")}function gotPv(e){let t=$("#pvs")[0],n=$("fieldset",t)[e[0]],i=$("input",n)[e[1]];0==e[2]?(i.type="text",i.value=(new Date).toLocaleTimeString()):i.value=e[3],i.dispatchEvent(new Event("change"))}function clearLog(){empty($("#log")[0])}function link(){for(let e of $("input[q-link]")){let t=e.getAttribute("q-link").split("/"),n=$("#"+t[0]+"s > fieldset[name="+t[1]+"] > input[name="+t[2]+"]")[0];if(n)switch("text"==e.type&&(e.type=n.type),e.value=n.value,t[0]){case"command":e.onclick=(()=>{n.dispatchEvent(new Event("click"))});break;case"setting":case"parameter":e.onblur=(()=>{n.value=e.value,n.dispatchEvent(new Event("blur"))}),n.addEventListener("change",()=>{e.value=n.value});break;case"pv":e.type="number",e.disabled=!0,"Registrieren"==n.value&&n.dispatchEvent(new Event("click")),n.addEventListener("change",()=>{e.value=n.value})}}for(let e of $("div[q-log]")){empty(e);let t=e.getAttribute("q-log"),n=[],i=document.createElement("a");i.download=t.replace(/[,\/]/g,"-")+".csv",i.style="display: none",e.appendChild(i);let o=document.createElement("input");o.type="button",o.value="Ein",e.appendChild(o),o.onclick=(()=>{if(e.hasAttribute("q-enabled")){e.removeAttribute("q-enabled");let t=window.URL.createObjectURL(new Blob(n,{type:"text/csv"}));i.href=t,i.click(),window.URL.revokeObjectURL(t),o.value="Ein",l.value=0,n=[n[0]]}else e.setAttribute("q-enabled","true"),o.value="Aus / Download"});let l=document.createElement("input");l.type="number",l.value=0,l.disabled=!0,e.appendChild(l),n.push("Time;"+t.replace(/,/g,";")+"\n");let a=t.split(",");for(let[t,i]of a.entries()){i=i.split("/");let o=$("#"+i[0]+"s > fieldset[name="+i[1]+"] > input[name="+i[2]+"]")[0];o&&(o.addEventListener("change",()=>{if(!e.hasAttribute("q-enabled"))return;let i=[];i.push(Date.now());for(let e=0;e<t;++e)i.push("");i.push(o.value),n.push(i.join(";")+"\n"),l.value=parseInt(l.value)+1}),"Registrieren"==o.value&&o.dispatchEvent(new Event("click")))}}}NodeList.prototype.indexOf=Array.prototype.indexOf;let ws,$=(e,t=document)=>t.querySelectorAll(e);window.addEventListener("load",function(e){init();for(let e of $("#intercom > p"))e.addEventListener("click",function(e){let t=e.target.nextSibling.style;"none"==t.display?t.display="inherit":t.display="none"});document.addEventListener("visibilitychange",function(){ws.send("[1,0]")})});