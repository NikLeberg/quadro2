"use strict";function empty(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function init(){ws=new WebSocket(`ws:/${window.location.hostname}/ws`),ws.onmessage=processMessage,ws.onclose=reconnect,ws.onopen=function(){ws.send("[7]"),ws.send("[8]"),ws.send("[9]"),ws.send("[10]"),setTimeout(link,2e3)}}function reconnect(){console.error("WebSocket getrennt. Erneut verbinden in 2 s..."),clearTimeout(ws.timeout),ws.timeout=setTimeout(init,2e3)}function processMessage(e){try{let t=JSON.parse(e.data),n=[void 0,gotStatus,gotLog,void 0,settingResponse,parameterResponse,gotPv,gotCommandList,gotSettingList,gotParameterList,gotPvList];n[t[0]](t[1])}catch(e){console.error(e)}displayConnectivity()}function displayConnectivity(){if("undefined"==displayConnectivity.locked&&(displayConnectivity.locked=!1),displayConnectivity.locked)return;displayConnectivity.locked=!0,setTimeout(function(){displayConnectivity.locked=!1},100);let e=$("#ws")[0],t={"-":"\\","\\":"|","|":"/","/":"-"};e.innerHTML=t[e.innerHTML]}function gotStatus(e){ws.send("[1,1]")}function gotLog(e){let t=$("[name=logFilter]")[0].value;if(!e.includes(t))return;let n=$("#log")[0],i=e.charAt(0),o=document.createElement("pre");o.innerHTML=e;let a={E:"red",W:"orange",I:"green",D:"black",V:"gray"};o.style.color=a[i],n.prepend(o)}function genericCreateForm(e,t,n,i,o){empty(t);for(let a of e){let e=document.createElement("fieldset");e.name=a[0],e.innerHTML=`<legend>${a[0]}</legend>`;for(let t of a[1])e.innerHTML+=`<input type="${n}" name="${t}" value="${i||t}">`,o&&(e.innerHTML+=`<label for="${t}">${t}</label><br>`);t.appendChild(e)}}function gotCommandList(e){let t=$("#commands")[0];genericCreateForm(e,t,"button",void 0,!1),t.addEventListener("click",commandClick,!0)}function commandClick(e){let t=e.target,n=t.parentNode,i=$("fieldset",t.form).indexOf(n),o=$("input",n).indexOf(t);ws.send(`[3,[${i},${o}]]`)}function gotSettingList(e){let t=$("#settings")[0];genericCreateForm(e,t,"number","0",!0),$("input",t).forEach(valueRequest),t.addEventListener("blur",valueBlur,!0)}function settingResponse(e){let t=$("#settings")[0],n=$("fieldset",t)[e[0]],i=$("input",n)[e[1]];i.setAttribute("qType",e[2]),i.value=e[3],i.dispatchEvent(new Event("change"))}function gotParameterList(e){let t=$("#parameters")[0];genericCreateForm(e,t,"number","0",!0),$("input",t).forEach(valueRequest),t.addEventListener("blur",valueBlur,!0)}function parameterResponse(e){let t=$("#parameters")[0],n=$("fieldset",t)[e[0]],i=$("input",n)[e[1]];i.setAttribute("qType",e[2]),i.value=e[3],i.dispatchEvent(new Event("change"))}function valueRequest(e){let t=e.parentNode,n=$("fieldset",e.form).indexOf(t),i=$("input",t).indexOf(e);ws.send(`[${"settings"==e.form.id?4:5},[${n},${i}]]`)}function valueBlur(e){let t=e.target,n=t.parentNode,i=$("fieldset",t.form).indexOf(n),o=$("input",n).indexOf(t),a=t.value;if(t.attributes.qType){switch(parseInt(t.attributes.qType.value)){case 1:a<0&&(a=0);case 2:a=Math.round(a);case 3:break;default:return}ws.send(`[${"settings"==t.form.id?4:5},[${i},${o},${a}]]`)}}function gotPvList(e){let t=$("#pvs")[0];genericCreateForm(e,t,"button","Registrieren",!0);for(let e of $("input",t))e.addEventListener("click",pvRegister)}function pvRegister(e){let t=e.target,n=t.parentNode,i=$("fieldset",t.form).indexOf(n),o=$("input",n).indexOf(t);t.value=0,t.type="number",ws.send(`[6,[${i},${o}]]`)}function gotPv(e){let t=$("#pvs")[0],n=$("fieldset",t)[e[0]],i=$("input",n)[e[1]];0==e[2]?(i.type="text",i.value=(new Date).toLocaleTimeString()):i.value=e[3],i.dispatchEvent(new Event("change"))}function clearLog(){empty($("#log")[0])}function link(){for(let e of $("input[q-link]")){let t=e.getAttribute("q-link").split("/"),n=$(`#${t[0]}s > fieldset[name=${t[1]}] > input[name=${t[2]}]`)[0];if(n)switch("text"==e.type&&(e.type=n.type),t[0]){case"command":e.value=n.value,e.onclick=(()=>{n.dispatchEvent(new Event("click"))});break;case"setting":case"parameter":e.value=n.value,e.onblur=(()=>{n.value=e.value,n.dispatchEvent(new Event("blur"))}),n.addEventListener("change",()=>{e.value=n.value});break;case"pv":e.type="number",e.disabled=!0,"Registrieren"==n.value&&n.dispatchEvent(new Event("click")),n.addEventListener("change",()=>{e.value=n.value})}}for(let e of $("div[q-log]")){empty(e);let t=e.getAttribute("q-log"),n=t.split(";"),i=[],o=document.createElement("a");o.style="display: none",e.appendChild(o);let a=document.createElement("input");a.type="button",a.value="Ein";let l=!1;a.onclick=(()=>{if(l){l=!1,o.download=`${n[0].replace(/\//g,"-")}_${(new Date).toISOString()}.csv`;let e=window.URL.createObjectURL(new Blob(i,{type:"text/csv"}));o.href=e,o.click(),window.URL.revokeObjectURL(e),a.value="Ein",r.value=0,i=[i[0]]}else l=!0,a.value="Aus / Download"}),e.appendChild(a);let r=document.createElement("input");r.type="number",r.value=0,r.disabled=!0,e.appendChild(r),i.push(`Time;${t}\n`);for(let[e,t]of n.entries()){t=t.split("/");let n=$(`#${t[0]}s > fieldset[name=${t[1]}] > input[name=${t[2]}]`)[0];n&&(n.addEventListener("change",()=>{if(!l)return;let t=[];t.push(Date.now());for(let n=0;n<e;++n)t.push("");t.push(n.value),i.push(t.join(";")+"\n"),r.value=r.valueAsNumber+1}),"Registrieren"==n.value&&n.dispatchEvent(new Event("click")))}}}function animateQuadro(){let e=[0,0,0],t=$("#quadro2")[0],n=$("input[q-link]",t),i=setInterval(()=>{e=[n[1].valueAsNumber,n[0].valueAsNumber,n[2].valueAsNumber],e[0]>Math.PI/2||e[0]<-Math.PI/2||e[1]>Math.PI/2||e[1]<-Math.PI/2?t.style.borderBottomColor="blue":t.style.borderBottomColor="red",t.style.transform=`rotateZ(${e[2]}rad) rotateY(${e[1]}rad) rotateX(${e[0]}rad)`},50);t.onclick=(()=>{i?(clearInterval(i),i=0):animateQuadro()})}NodeList.prototype.indexOf=Array.prototype.indexOf;let ws,$=(e,t=document)=>t.querySelectorAll(e);window.addEventListener("load",function(e){init();for(let e of $("#intercom > p"))e.onclick=function(e){let t=e.target.nextSibling.style;"none"==t.display?t.display="inherit":t.display="none"};document.addEventListener("visibilitychange",function(){ws.send("[1,0]")}),animateQuadro()});